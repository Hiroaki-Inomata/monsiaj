<?xml version="1.0" encoding="us-ascii"?>
<!-- $Id: build.xml,v 1.20 2004-06-10 09:34:02 ozawa Exp $ -->
<project name="panda-client" default="dist" basedir=".">

  <!-- properties -->

  <property name="compile.debug"       value="yes"/>
  <property name="compile.deprecation" value="yes"/>
  <property name="compile.verbose"     value="no"/>
  <property name="clean.verbose"       value="no"/>

  <property name="src.dir"             value="src"/>
  <property name="build.dir"           value="bin"/>
  <property name="tmp.dir"             value="tmp"/>
  <property name="dist.dir"            value="dist"/>
  <property name="resources.dir"       value="resources"/>
  <property name="libs.dir"            value="libs"/>
  <property name="report.dir"          value="report"/>

  <property name="webstart.url"        value="http://localhost/java-client/"/>

  <path id="project.class.path">
    <pathelement path="libs/*.jar"/>
  </path>

  <!-- targets -->

  <target name="prepare"
          description="Sets the timestamp and creates directories">
    <tstamp/>
    <mkdir dir="${build.dir}"/>
    <mkdir dir="${tmp.dir}"/>
    <mkdir dir="${dist.dir}"/>
    <mkdir dir="${report.dir}"/>
    <condition property="exclude.j2selogger" value="**/J2SELogger.java">
      <not>
        <available classname="java.util.logging.Logger"/>
      </not>
    </condition>
    <condition property="exclude.log4jlogger" value="**/Log4JLogger.java">
      <not>
        <available classname="org.apache.log4j.Logger"/>
      </not>
    </condition>
    <condition property="exclude.ssl" value="**/SSLSocketCreator.java">
      <not>
        <available classname="javax.net.ssl.SSLSocket"/>
      </not>
    </condition>
    <condition property="exclude.prefs" value="**/PreferenceBasedConfiguration.java">
      <not>
        <available classname="java.util.prefs.Preferences"/>
      </not>
    </condition>
  </target> 

  <target name="compile" depends="prepare"
    description="Compiles all Java sources.">
    <javac srcdir="${src.dir}"
           destdir="${build.dir}"
           verbose="${compile.verbose}"
	   deprecation="${compile.deprecation}" 
           debug="${compile.debug}"
           source="1.4">
      <include name="**/*.java"/>
      <exclude name="${exclude.j2selogger}"/>
      <exclude name="${exclude.log4jlogger}"/>
      <exclude name="${exclude.ssl}"/>
      <exclude name="${exclude.prefs}"/>
      <exclude name="**/Test*.java"/>
      <classpath refid="project.class.path"/>
    </javac>
  </target>

  <target name="resources" depends="prepare">
    <copy todir="${build.dir}">
      <fileset dir="${src.dir}" includes="**/*.properties,**/*.jpg,**/*.png"/>
    </copy>
    <native2ascii src="${resources.dir}" dest="${build.dir}"
      includes="*.jnlp" encoding="EUC-JP"/>
    <filter token="webstarturl" value="${webstart.url}"/>
    <copy todir="${tmp.dir}" filtering="true">
      <fileset dir="${build.dir}" includes="*.jnlp"/>
    </copy>
    <delete verbose="${clean.verbose}" quiet="true">
      <fileset dir="${build.dir}" includes="*.jnlp"/>
    </delete>
    <native2ascii src="${tmp.dir}" dest="${build.dir}"
      includes="*.jnlp" encoding="UTF-8" reverse="true"/>
  </target>

  <target name="dist" depends="compile,resources"
          description="Build files to be distributed.">
    <!-- ant 1.5.x should use destfile instead of jarfile-->
    <jar jarfile="${dist.dir}/pandaclient.jar"
         basedir="${build.dir}"
         includes="org/montsuqi/**/*.class,org/montsuqi/**/*.properties,org/montsuqi/**/*.png"
         manifest="${resources.dir}/manifest.mf"/>
    <jar jarfile="${dist.dir}/jmareceipt.jar"
         basedir="${build.dir}"
         includes="jp/or/med/jma_receipt/**/*.class,jp/or/med/jma_receipt/**/*.properties,jp/or/med/jma_receipt/**/*.jpg"
         manifest="${resources.dir}/jmareceipt.mf"/>
    <copy todir="${dist.dir}">
      <fileset dir="${libs.dir}" includes="*.jar" excludes="jfcunit.jar"/>
    </copy>
    <copy todir="${dist.dir}">
      <fileset dir="${build.dir}" includes="*.jnlp"/>
    </copy>
    <!-- ant 1.5.x should use destfile instead of zipfile-->
    <zip zipfile="${dist.dir}/monsiaj-${DSTAMP}.zip">
      <fileset dir="${dist.dir}" includes="*.jar"/>
    </zip>
  </target>

  <target name="buildclean"
          description="Cleans all built files.">
    <delete verbose="${clean.verbose}" quiet="true">
      <fileset dir="${build.dir}"/>
    </delete>
  </target>

  <target name="clean"
          description="Cleans temporary files and outputs.">
    <delete verbose="${clean.verbose}" quiet="true">
      <fileset dir="." defaultexcludes="no" includes="**/*~,**/.#*#"/>
    </delete>
  </target>

  <target name="veryclean" depends="clean,buildclean"
    description="Cleans all generated files.">
    <delete dir="${build.dir}" verbose="${clean.verbose}" quiet="true"/>
    <delete dir="${dist.dir}"  verbose="${clean.verbose}" quiet="true"/>
    <delete dir="${report.dir}" verbose="${clean.verbose}" quiet="true"/>
  </target>

  <target name="jars"
    description="*obsolete* Deploy jars.">
    <echo message="Taret 'jars' is obsolete. Use 'dist' instead."/>
    <antcall target="dist"/>
  </target>

  <target name="compiletests" depends="compile,resources"
    description="Compiles Test Java sources.">
    <javac srcdir="${src.dir}"
           destdir="${build.dir}"
           verbose="${compile.verbose}"
	   deprecation="${compile.deprecation}" 
           debug="${compile.debug}">
      <include name="**/Test*.java"/>
      <classpath>
	<pathelement path="libs/jfcunit.jar"/>
	<pathelement path="${build.dir}"/> 
      </classpath>
    </javac>
  </target>

  <target name="runtests" depends="compiletests"
    description="Run all junit test.">
    <junit printsummary="on"
           fork="false"
           haltonfailure="false">
      <formatter type="xml"/>
      <classpath>
	<pathelement path="libs/jfcunit.jar"/>
	<pathelement path="${build.dir}"/> 
      </classpath>
  
      <batchtest todir="${report.dir}">
	<fileset dir="${src.dir}">
	  <include name="**/Test*.java"/>
	</fileset>
      </batchtest>
    </junit>

    <junitreport todir="${report.dir}">
      <fileset dir="${report.dir}">
	<include name="TEST-*.xml"/>
      </fileset>
      <report format="frames" todir="${report.dir}"/>
    </junitreport>

  </target>

  <target name="singletest" depends="compiletests"
    description="Run single target junit test.">
    <property name="testcase"
              value="org/montsuqi/widgets/TestWindow"/>
    <junit printsummary="on"
           fork="false"
           haltonfailure="false">
      <formatter type="plain" usefile="false"/>
      <classpath>
	<pathelement path="libs/jfcunit.jar"/>
	<pathelement path="${build.dir}"/> 
      </classpath>

      <test name="${testcase}"/>

    </junit>
  </target>

</project>
